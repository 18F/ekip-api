{% extends "base-redemption.html" %}

{% load humanize %}

{% block title %}Statistics{% endblock title %}

{% block content %}

    <style type="text/css">
      h1,
      h2 {
        font-family: "Superclarendon", serif;
      }

      h1 {
        font-size: 2.5em;
        padding: 15px;
        margin-bottom: 10px;
      }

      h2 {
        padding-bottom: 15px;
      }

      #content {
        padding-top: 0;
      }

      .stats_header {
        background: #489BC0;
        color: #FFFFFF;
      }

      .passes,
      .exchanges {
        background: #FDEED0;
        padding: 15px 25px;
        margin-bottom: 15px;
        clear: both;
      }

      .pass_details,
      .exchange_details {
        cursor: pointer;
      }

      .chart_inputs {
        padding-bottom: 15px;
      }

      .paper_passes {
        max-width: 500px;
        float: left;
      }

      .passes_generated {
        width: 220px;
        float: right;
      }

      .generated_pass_details {
        clear: both;
      }

      .generated_pass_details div {
        display: none;
      }

      .exchange_details_content {
        padding-top: 15px;
        display: none;
      }

      @media (max-width: 500px) {
        .passes_generated {
          max-width: 100%;
          float: none;
        }
      }

    </style>

    <div class="stats_header">
      <h1>Every Kid in a Park statistics</h1>
    </div>

    <div class="passes">

      <h2>Paper passes</h2>

      <div class="paper_passes">

        <h3>Student Passes Generated By Month <a class="pass_details">(details)</a></h3>

        <div class="chart_inputs">
          <input id="date-start" name="date-start" type="text" class="datepicker required" value="{{start_date}}"></input>
          to
          <input id="date-end" name="date-end" type="text" class="datepicker required" value="{{end_date}}"></input>
          <button id="refresh-data-button">Refresh Data</button>
        </div>

        <div id="chart_dates"></div>

        <!-- Temporarily hiding the Pass by state breakdown chart -->
        <!--     <p> Redemption site States of generated Tickets.</p>
        <div id="chart_states"></div> -->

      </div>

      <div class="passes_generated">

        <h3>System Generated Passes</h3>

        <p>Educator workflow: <b>{{educator_tickets_issued|intcomma}}</b></p>

        <p>Student workflow: <b>{{num_tickets_issued|intcomma}}</b></p>

      </div>

      <div class="generated_pass_details">

        <div>
          <p>Numbers for paper passes represent the number of times the Every Kid in a Park website has generated an electronic paper pass for a
          website visitor.  Website visitors include fourth-grade students, parents, and educators; they also include members of the general public
          and other visitors.</p>

          <p>The numbers reported here represent aggregate counts of the number of times an electronic paper pass have been generated. These numbers <b>do not</b> represent:</p>

          <ul>
             <li>The number of fourth graders who have generated an electronic paper pass</li>
             <li>The number of times an electronic paper pass has been printed</li>
             <li>The number of fourth graders reached through this program</li>
             <li>For the educator workflow, the number of educators who have used the system</li>
             <li>System-generated paper passes through <a href="https://everykidinapark.gov/get-your-pass/fourth-grader" target="_blank">student</a> workflow.</li>
          </ul>
        </div>

      </div>

    </div>

    <div class="exchanges">

      <h2>Exchanges</h2>

      <h3>Total paper passes exchanged for plastic passes: {{all_exchanged|intcomma}}</h3>

      <h3>Passes exchanged with duplicates removed: {{num_tickets_exchanged|intcomma}}</h3>

      <hr>

      <p>Exchanges represent the physical exchange of the printed, paper pass for the plastic pass.  These represent numbers reported
      directly by the fee collectors.</p>

      <p>These numbers represent the aggregate count of paper passes that have been reported as exchanged for plastic passes by fee collectors.  These numbers <b>do not</b> represent:</p>
      <ul>
        <li>The number of paper pass holders who have used the paper pass to gain entry to a federal land or water</li>
        <li>The number of fourth graders who have received a plastic pass</li>
        <li>The number of fourth graders who have exchanged a paper pass for a plastic passâ€” this number does not include numbers reported
        by Army Corps of Engineers, and it includes anyone who was able to successfully exchange the paper pass for a plastic one</li>
      </ul>

    </div>

    <script type="text/javascript">

        $(function() {

            $('.pass_details').click(function () {
              $('.generated_pass_details div').toggle();
            });

            // Initialized data.
            var tickets_dates = JSON && JSON.parse('{{tickets_dates | safe}}');
            var tickets_states = JSON && JSON.parse('{{tickets_states | safe}}');

            var start_date = '{{start_date | safe}}';
            var end_date = '{{end_date | safe}}';

            // Date Chart generation.
            var drawCharts = function(tickets_dates, tickets_states){

                var xvals_dates,yvals_dates,yvals_states,xvals_states, columns_states;

                // Format breakdown by date data.
                tickets_dates = _.sortBy(tickets_dates, function(o) { return o.date; });
                xvals_dates = _.pluck(tickets_dates, 'date');
                yvals_dates = _.pluck(tickets_dates, 'count');

                // Format breakdown by state data.
                tickets_states = _.sortBy(tickets_states, function(o) { return o.date; });
                xvals_states = _.pluck(tickets_states, 'state');
                yvals_states = _.pluck(tickets_states, 'count');

                //[a,b] [c,d] => [[a,c],[b,d]]
                columns_states = _.zip(xvals_states, yvals_states);
                var chart_dates = c3.generate({
                    bindto: '#chart_dates',
                    data: {
                        x: 'date',
                        xFormat : '%Y%m',
                        columns: [
                            ['date'].concat(xvals_dates),
                            ['passes'].concat(yvals_dates)
                        ],
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                format: '%m/%y',
                                culling: {
                                    // Limit the max number of ticks.
                                    max: 6
                                },
                                fit: true
                            },
                            label: {
                                text: 'Dates (MM/YY)',
                                position: 'outer-left'
                            }
                        },
                        y: {
                            label: {
                                text: 'Passes Generated',
                                position: 'middle'
                            }
                        }
                    }
                });

                // Breakdown by State Chart generation.
                var chart_states = c3.generate({
                    bindto: '#chart_states',
                    data: {
                        columns: columns_states,
                        type : 'bar'
                    },
                     bar: {
                        width: {
                            ratio: 0.1 // this makes bar width 50% of length between ticks
                        }
                    },
                    axis: {
                        x : {
                            type : 'categorized',
                            tick: {
                                format: function (x) { return ''; }
                            },
                            label: {
                                text: 'Pass Destination',
                                position: 'middle'
                            }
                        },
                        y: {
                            label: {
                                text: 'Passes Generated',
                                position: 'outer-left'
                            }
                        },
                        rotated: true
                    }
                });
            };

            // Init. Datepickers.
            $( ".datepicker" ).datepicker();

            // Draw charts.
            drawCharts(tickets_dates, tickets_states);

            // Date Select Button.
            // Refreshes chart data to selected date ranges.
            $("#refresh-data-button").click(function(){
                var data = {};
                data.start = $("#date-start").val();
                data.end = $("#date-end").val();

                $.get("/redeem/statistics/refresh", data, function(ret, status) {
                    var tickets_dates = JSON && JSON.parse(ret.tickets_by_dates);
                    var tickets_states = JSON && JSON.parse(ret.tickets_by_states);
                    // Redraw Charts.
                    drawCharts(tickets_dates, tickets_states);

                    // Update Date Ranges.
                    $('#start_date').text(data.start);
                    $('#end_date').text(data.end);
                });

            });
        });

    </script>

{% endblock content %}



