{% extends "base-redemption.html" %}

{% load humanize %}

{% block title %}Statistics{% endblock title %}

{% block content %}

    <h1>Every Kid in a Park statistics</h1>
    {{tickets}}

    <h2>Paper passes</h2>

    <p>Numbers for paper passes represent the number of times the Every Kid in a Park website has generated an electronic paper pass for a
    website visitor.  Website visitors include fourth-grade students, parents, and educators; they also include members of the general public
    and other visitors.</p>

    <p>The numbers reported here represent aggregate counts of the number of times an electronic paper pass have been generated.  These numbers <b>do not</b> represent:</p>
    <ul>
       <li>The number of fourth graders who have generated an electronic paper pass</li>
       <li>The number of times an electronic paper pass has been printed</li>
       <li>The number of fourth graders reached through this program</li>
       <li>For the educator workflow, the number of educators who have used the system</li>
   </ul>

    <p>If you're still not sure what these numbers represent, or if you'd like more help interpreting them, please ask us!</p>
    <p>System-generated paper passes through <a href="https://everykidinapark.gov/get-your-pass/fourth-grader" target="_blank">student</a> workflow.</p>
    


<!--     <h4>
        Student Passes Generated from 
            <div id="start_date">{{start_date}}</div> 
            to 
            <div id="end_date">{{end_date}}</div>
    </h4> -->
    <h4>
    Student Passes Generated from 
    
    <input id="date-start" name="date-start" type="text" class="datepicker required" value="{{start_date}}"></input> 
    to
    <input id="date-end" name="date-end" type="text" class="datepicker required" value="{{end_date}}"></input>
    <button id="refresh-data-button">Refresh Data</button>
    </h4>

    <p> Student Passes generated by date.</p>
    <div id="chart_dates"></div>
    <p> Redemption site States of generated Tickets.</p>
    <div id="chart_states"></div>


    <p>System-generated paper passes, educator worfklow only: <b>{{educator_tickets_issued|intcomma}}</b></p>

    <p>System-generated paper passes through <a href="https://everykidinapark.gov/get-your-pass/fourth-grader" target="_blank">student</a> and <a href="https://everykidinapark.gov/get-your-pass/educator" target="_blank">educator</a> workflows: <b>{{num_tickets_issued|intcomma}}</b></p>

    <h2>Exchanges</h2>

    <p>Exchanges represent the physical exchange of the printed, paper pass for the plastic pass.  These represent numbers reported
    directly by the fee collectors.</p>

    <p>These numbers represent the aggregate count of paper passes that have been reported as exchanged for plastic passes by fee collectors.  These numbers <b>do not</b> represent:</p>
        <li>The number of paper pass holders who have used the paper pass to gain entry to a federal land or water</li>
        <li>The number of fourth graders who have received a plastic pass</li>
        <li>The number of fourth graders who have exchanged a paper pass for a plastic passâ€” this number does not include numbers reported
        by Army Corps of Engineers, and it includes anyone who was able to successfully exchange the paper pass for a plastic one</li>


    <p>Paper passes exchanged for plastic passes (includes paper passes used more than once): <b>{{all_exchanged|intcomma}}</b></p>

    <p>Unique paper passes exchanged for plastic passes (duplicates removed): <b>{{num_tickets_exchanged|intcomma}}</b></p>


    <script type="text/javascript"> 

        $(function() {

            // Initialized data.
            var tickets_dates = JSON && JSON.parse('{{tickets_dates | safe}}');
            var tickets_states = JSON && JSON.parse('{{tickets_states | safe}}');

            var start_date = '{{start_date | safe}}';
            var start_date = '{{end_date | safe}}';

            // Date Chart generation.
            var drawCharts = function(tickets_dates, tickets_states){

                var xvals_dates,yvals_dates,yvals_states,xvals_states, columns_states;

                // Format breakdown by date data.
                tickets_dates = _.sortBy(tickets_dates, function(o) { return o.date; });
                xvals_dates = _.pluck(tickets_dates, 'date');
                yvals_dates = _.pluck(tickets_dates, 'count');

                // Format breakdown by state data.
                tickets_states = _.sortBy(tickets_states, function(o) { return o.date; });
                xvals_states = _.pluck(tickets_states, 'state');
                yvals_states = _.pluck(tickets_states, 'count');

                //[a,b] [c,d] => [[a,c],[b,d]]
                columns_states = _.zip(xvals_states, yvals_states);
                var chart_dates = c3.generate({
                    bindto: '#chart_dates',
                    data: {
                        x: 'date',
                        xFormat : '%Y%m%d',
                        columns: [
                            ['date'].concat(xvals_dates),
                            ['passes'].concat(yvals_dates)
                        ],
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                format: '%m/%d/%y',
                                culling: {
                                    // Limit the max number of ticks.
                                    max: 6
                                },
                                fit: true
                            },
                            label: {
                                text: 'Dates',
                                position: 'outer-left'
                            }
                        },
                        y: {
                            label: {
                                text: 'Passes Generated',
                                position: 'middle'
                            }
                        }
                    }
                });

                // Breakdown by State Chart generation.
                var chart_states = c3.generate({
                    bindto: '#chart_states',
                    data: {
                        columns: columns_states,
                        type : 'bar'
                    },
                     bar: {
                        width: {
                            ratio: 0.1 // this makes bar width 50% of length between ticks
                        }
                    },
                    axis: {
                        x : {
                            type : 'categorized',
                            tick: {
                                format: function (x) { return ''; }
                            },
                            label: {
                                text: 'Pass Destination',
                                position: 'middle'
                            }
                        },
                        y: {
                            label: {
                                text: 'Passes Generated',
                                position: 'outer-left'
                            }
                        },
                        rotated: true
                    }
                });
            };

            // Init. Datepickers.
            $( ".datepicker" ).datepicker();

            // Draw charts.
            drawCharts(tickets_dates, tickets_states);

            // Date Select Button. 
            // Refreshes chart data to selected date ranges.
            $("#refresh-data-button").click(function(){
                var data = {};
                data.start = $("#date-start").val();
                data.end = $("#date-end").val();

                $.get("/redeem/statistics/refresh", data, function(ret, status) {
                    var tickets_dates = JSON && JSON.parse(ret.tickets_by_dates);
                    var tickets_states = JSON && JSON.parse(ret.tickets_by_states);
                    // Redraw Charts.
                    drawCharts(tickets_dates, tickets_states);

                    // Update Date Ranges.
                    $('#start_date').text(data.start);
                    $('#end_date').text(data.end);
                });

            });
        });

    </script>

{% endblock content %}



